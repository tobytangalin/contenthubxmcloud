<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en" dir="ltr"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<meta http-equiv="x-ua-compatible" content="IE=edge"></meta><meta name="format-detection" content="telephone=no"></meta><meta name="viewport" content="width=device-width, initial-scale=1"></meta><meta name="search" content="default"></meta><meta name="use.ic" content="no"></meta><meta name="Audience - do not use" content=""></meta><meta name="clubot" content=""></meta><meta name="data model" content=""></meta><meta name="DxP type - Do Not Use" content=""></meta><meta name="media_icon" content=""></meta><meta name="product" content="XM Cloud"></meta><meta name="Publishing target" content="Production"></meta><meta name="Ready for publishing - do not use" content=""></meta><meta name="role" content="developers"></meta><meta name="topic_tripane" content=""></meta><meta name="version" content=""></meta><meta name="tocstandalone" content="yes"></meta><meta name="theme" content="1"></meta><meta name="search.placeholder" content="Search"></meta><meta name="search.results" content="Search results"></meta><meta name="no.search.results" content="No results found"></meta><script type="text/javascript">
var theme = '1';

			
			window.versionsfile = '';


			window.indexDict = new Array();
			window.store = {};
			window.portalLanguage = 'en';
			window.enterKey = 'select';
			
			
				var fuse_threshold = 0.3;
			
					var local_csh = false;
				
					var anchoroption = true;
				var instantsearch_minlength = 1;
						
			var useanchorlinks = false;
			
					function addSearch(){
					//not used with custom or elastic search
					}
				</script><title>The Next.js Personalize add-on</title><link rel="stylesheet" type="text/css" href="../css/docbook.css"></link><link rel="stylesheet" type="text/css" href="../css/font-awesome.css"></link><link rel="stylesheet" type="text/css" href="../css/roboto.font.css"></link><link rel="stylesheet" type="text/css" href="../css/theme1.css?version=20230630"></link><link rel="stylesheet" type="text/css" href="../css/theme1-colors.css?version=20230630"></link><link rel="stylesheet" type="text/css" href="../css/content-theme1.css?version=20230630"></link><link rel="stylesheet" type="text/css" href="../css/sm-core-css.css"></link><link rel="stylesheet" type="text/css" href="../css/sm-simple.css"></link><link rel="stylesheet" type="text/css" href="../css/style-print.css"></link><link rel="stylesheet" type="text/css" href="../css/style-common.css"></link><link rel="stylesheet" type="text/css" href="../css/style-modern-tables.css"></link><link rel="stylesheet" type="text/css" href="../css/graphical-lists.css"></link><link rel="stylesheet" type="text/css" href="/css/sitecore-custom-default-xmc.css?version=20230630"></link><script src="../js/jquery-3/jquery-3.4.1.min.js" type="text/javascript"></script><script src="../js/jquery-migrate-3.0.1.min.js" type="text/javascript"></script><script src="../js/materialize.min.js" type="text/javascript"></script><script src="../js/bootstrap.min.js" type="text/javascript"></script><script src="../js/purl.js" type="text/javascript"></script><script src="../js/jquery.smartmenus.js" type="text/javascript"></script><script src="js/toc.js?version=20230630" type="text/javascript"></script><script src="../js/create-toc.js" type="text/javascript"></script><script src="../js/html5-2-mp-common.js?version=20230630" type="text/javascript"></script><script src="../js/html5-2.js?version=20230630" type="text/javascript"></script><script src="../js/checklist.js" type="text/javascript"></script><script src="../js/clipboard.min.js" type="text/javascript"></script><script src="../js/csh.js" type="text/javascript"></script><script src="/js/layout-custom-script.js" type="text/javascript"></script><meta xmlns:xhtml="http://www.w3.org/1999/xhtml" name="generator" content="Paligo"></meta><meta name="description" content="Learn about the add-on that enables Next.js applications to get and render personalized page variants from XM Cloud."></meta><link rel="prev" href="add-ons-for-next-js-applications.html" title="Add-ons for Next.js applications"></link><link rel="next" href="the-next-js-personalize-add-on.html#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372" title="Architecture overview"></link><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML" async="async"></script><link rel="icon" href="/favicon.ico" type="image/x-icon"></link><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.css"></link><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent/3.1.1/cookieconsent.min.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.1/js.cookie.min.js"></script><script type="text/javascript">var privacypolicy = 'https://www.sitecore.com/trust/privacy-policy';
var consenttype = 'opt-out';
</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-72664331-1"></script><script type="text/javascript">const measurementId = 'UA-72664331-1';

						$(document).on('cookies.consented', () => {
							window.dataLayer = window.dataLayer || [];
							function gtag(){dataLayer.push(arguments)};

							gtag('js', new Date());
							gtag('config', measurementId);
						});
					</script><script type="text/javascript" src="../js/cookie-consent.js"></script><script type="text/javascript">
				$(document).ready(function () {
				$(".mediaobject img").addClass('materialboxed');
				//Exclude images with links
				$(".mediaobject a img").removeClass('materialboxed');
				if (!document.documentMode) {
				$('.materialboxed').materialbox();
				}});
			</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/styles/googlecode.min.css"></link><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script><script type="text/javascript">
			$(document).ready(function() {

				$('pre:not(.embedcode)').each(function() {
					/**
					 * @type {string}
					 */
					var language = $(this).data('language');

					if (language === 'plaintext' || language === 'text') {
						$(this).addClass(language).addClass('hljs');
						return true;
					}
					else {
						var clone = this.cloneNode(true);
						hljs.highlightBlock(clone);
						$(this).empty().append($(clone).contents());
						$(this).attr("class", $(clone).attr("class"));
					}
				});
			});
			</script><link href="//customer.cludo.com/assets/2063/10039/cludo-search.min.css" type="text/css" rel="stylesheet"></link></head><body class="theme1 colored-top page-toc current-toc-section-focus" data-spy="scroll" data-target=".section-nav-container" data-offset="100" data-link-prefix=""><style type="text/css">
            div.skipnav {
            }
            div.skipnav a {
                position: fixed;
                left: -10000px;
                top: 1.5em;
                width: 1px;
                height: 1px;
                overflow: hidden;
            }
            div.skipnav a:focus, div.skipnav a:active, div.skipnav a:hover {
                background: white;
                color: black;
                box-shadow: 5px 5px 5px 0px rgba(0,0,0,0.5);
                position: fixed;
                left: 2em;
                top: 1.5em;
                width: auto;
                height: auto;
                overflow: visible;
                text-decoration: underline;
                z-index: 99999; /* has to be higher than the side panel */
    }
          </style><div class="skipnav"><a href="#content-wrapper">Skip to main content</a></div><header class="site-header"><nav class="site-header-navbar navbar navbar-fixed-top"><div class="navbar-container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><div id="logotype-container" class="pull-left"><a class="navbar-brand" href="https://doc.sitecore.com/xmc/" target="_blank" rel="noopener"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div></div><div class="navbar-collapse collapse" id="navbar"></div></div></nav></header><div class="site-body"><div class="site-body-container"><div class="site-body-row"><aside xmlns:xinfo="http://ns.expertinfo.se/cms/xmlns/1.0" class="site-sidebar"><div class="site-sidebar-header"><a href="https://doc.sitecore.com/xmc/" target="_blank"><img id="logotype-pageheader" src="../css/image/corporate-logo.png" alt="Corporate logotype" data-role="logotype" class="logo"></img></a></div><form id="search-form" class="site-sidebar-search" autocomplete="off"><input type="text" class="form-control search-field" placeholder="Search" id="aa-search-input"></input></form><div id="toc-standalone-placeholder"></div></aside><div class="site-content"><div class="toolbar"><div class="toolbar-tools"><div id="navbar" class="navbar-collapse collapse"></div><div class="tool-print"><i class="fa fa-print" aria-hidden="true">print</i></div><div class="tool-search"><i class="fa fa-search" aria-hidden="true"></i></div><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".site-sidebar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button></div><div class="breadcrumb-container"><ul class="breadcrumb"><li class="breadcrumb-link"><a href="index-en.html">XM Cloud Documentation for Developers</a></li><li class="breadcrumb-link"><a href="sitecore-javascript-rendering-sdks--jss-.html">Sitecore JavaScript Rendering SDKs (JSS)</a></li><li class="breadcrumb-link"><a href="sitecore-javascript-rendering-sdk--jss--for-next-js.html">Sitecore JavaScript Rendering SDK (JSS) for Next.js</a></li><li class="breadcrumb-link"><a href="add-ons-for-next-js-applications.html">Add-ons for Next.js applications</a></li><li class="breadcrumb-node">The Next.js Personalize add-on</li></ul></div></div><main><div id="top-pager"><ul class="pager"><li class="previous"><a accesskey="p" class="prev pull-left prev visible-lg visible-md" id="header-navigation-prev" href="add-ons-for-next-js-applications.html">Prev</a></li><li class="next"><a accesskey="n" class="pull-right next visible-lg visible-md" id="header-navigation-next" href="the-next-js-personalize-add-on.html#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372">Next</a></li></ul></div><article class="topic content-container" id="content-wrapper"><div id="topic-content" class="topic-content"><section xml:lang="en" lang="en" dir="ltr" class="section" data-origin-id="UUID-5cc54d49-230c-a1d3-2585-080e952ed98d" data-permalink="the-next-js-personalize-add-on.html" data-topic-level="1" data-relative-prefix="" data-time-modified="06/29/2023" data-publication-date="06/30/23" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e"><div class="titlepage"><div><div class="title"><h1 class="title" style="clear: both">The Next.js Personalize add-on<span id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_UUID-cca2866e-b1c5-d911-3cac-a85be3facd61"></span></h1></div><div><div class="abstract"><div class="abstract-title">Abstract</div><p>Learn about the add-on that enables Next.js applications to get and render personalized page variants from XM Cloud.</p></div></div></div></div><p>The Next.js Personalize add-on includes an example setup for projects using XM Cloud Embedded Personalization. It uses <a class="link" href="https://nextjs.org/docs/advanced-features/middleware" target="_blank" rel="noopener">Next.js Middleware</a> architecture to enable personalization at the edge, combined with the <a class="link" href="https://www.npmjs.com/package/@sitecore/engage" target="_blank" rel="noopener">Sitecore Engage SDK</a> for Page View events in the browser.</p><p>This add-on is automatically included when creating a new XM Cloud project using a Starter Kit. You can also add it using the <a class="link linktype-component" href="the-jss-app-initializer.html" title="The JSS app initializer">JSS initializer</a>.</p><p>This add-on includes the following:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>A Next.js Middleware plugin.</p></li><li class="listitem"><p>A React component for Page View events using the Sitecore Engage SDK.</p></li><li class="listitem"><p>A Page Props Factory plugin.</p></li><li class="listitem"><p>Point of Sale (POS) population for the default Site Resolver plugin. In XM Cloud, the POS is referred to as <span class="guilabel">Site identifier</span>.</p></li><li class="listitem"><p>Additional environment variables for configuration.</p></li></ul></div><div dir="ltr" class="note"><h3 class="title">Note</h3><p>The Next.js Personalize add-on is only one piece of the embedded personalization feature of XM Cloud. You must use other tools in the suite to accomplish other tasks. For example:</p><div class="itemizedlist"><ul style="list-style-type: disc; " class="itemizedlist"><li class="listitem"><p>Use XM Cloud Pages Personalize to <a class="link linktype-component" data-olink="true" href="/xmc/en/users/xm-cloud/en/create-a-page-variant.html">create personalized page variants</a>. These variants are stored on the page layout data in Sitecore Experience Edge when published.</p></li><li class="listitem"><p>Use XM Cloud Pages Analyze to view Page View events.</p></li></ul></div></div><section dir="ltr" class="section accordion" data-origin-id="" data-publication-date="06/30/23" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372_body" data-parent="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372"><div><div class="title"><h2 class="title" style="clear: both">Architecture overview</h2></div></div></a></div></div><div class="panel-body collapse" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372_body"><p>Personalization starts with a visitor page request.</p><p>The following diagram shows a generic visitor request flow using the Next.js Personalize add-on.</p><div class="mediaobject"><img src="image/uuid-2f799532-262f-25ce-c9db-dcf5d7f83d6f.png" style="" alt="Sequence/interaction diagram for the visitor request flow."></img></div><p>The middleware tries to identify the personalized page variant to display based on the request/user context. If the middleware successfully identifies a page variant, it rewrites the path to the page variant path (personalized rewrite path).</p><p>The Next.js app parses the personalized rewrite path to get the variant. It then manipulates the layout and displays the correct personalized page to the visitor.</p><p>In the browser, the Sitecore Engage SDK triggers Page View events.</p></div></div></section><section dir="ltr" class="section accordion" data-origin-id="" data-publication-date="06/30/23" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4568099155700833297646658689"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4568099155700833297646658689_body" data-parent="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4568099155700833297646658689"><div><div class="title"><h2 class="title" style="clear: both">Understanding the personalized rewrite path</h2></div></div></a></div></div><div class="panel-body collapse" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4568099155700833297646658689_body"><p>The Personalize add-on uses a rewrite path to identify personalized page variants.</p><p>The rewrite path is:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Set by Personalize Middleware to the identified page variant.</p></li><li class="listitem"><p>Read by the Next.js app to manipulate the layout and feed to Page View events.</p></li><li class="listitem"><p>Used to <a class="link linktype-component" href="walkthrough--configuring-the-next-js-personalize-add-on.html#UUID-61764482-7acb-eb74-2f5f-c25ebad67554_section-idm1403329768571048" title="Enable static generation for personalized variants">enable static generation for personalized page variants</a>.</p></li></ul></div><p>The JSS Next.js SDK and Next.js Personalize add-on encapsulate the logic for these processes so that you don't have to manipulate this path directly. However, it's helpful to understand in case of troubleshooting or customizations.</p><p>The structure of the personalized rewrite path is:</p><pre class="programlisting plaintext" data-language="plaintext" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_programlisting-idm4621111411388833297754101344">/_variantId_&lt;variantId&gt;/&lt;path&gt;</pre><p>For example, a page with the path <code class="code">/foo/bar</code> and the personalized variant <code class="code">1234</code> , is represented by the path <code class="code">/_variantId_1234/foo/bar</code>.</p></div></div></section><section dir="ltr" class="section accordion" data-origin-id="" data-publication-date="06/30/23" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041657171233297649869879"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041657171233297649869879_body" data-parent="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041657171233297649869879"><div><div class="title"><h2 class="title" style="clear: both">APIs</h2></div></div></a></div></div><div class="panel-body collapse" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041657171233297649869879_body"><p>The Personalize add-on uses the following code artifacts to render personalized page variants:</p><h3 id="idm45599227700032" class="bridgehead">PersonalizeMiddleware</h3><p>The <code class="code">PersonalizeMiddleware</code> is a Next.js middleware handler that enables Sitecore personalization of pages.</p><p>The middleware:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>Makes a call to the Sitecore Experience Edge endpoint to get the personalization information about the page, including variants.</p></li><li class="listitem"><p>Calls the Sitecore CDP endpoint with request/user context to determine the page variant to display based on the response.</p></li><li class="listitem"><p>Rewrites the response to the specific page variant using the personalized rewrite path.</p></li></ul></div><p>For additional information, see the <a class="link" href="https://github.com/Sitecore/jss/blob/release/21.0.0/ref-docs/sitecore-jss-nextjs/modules/middleware.md" target="_blank" rel="noopener">reference documentation</a>.</p><h3 id="idm45599227696112" class="bridgehead">normalizePersonalizedRewrite</h3><p>The <code class="code">normalizePersonalizedRewrite</code> function removes personalization data from a personalized rewrite path so that layout data can be appropriately retrieved. The function is used by the Page Props Factory <code class="code"> extractPath</code> function defined in the <code class="code">src\lib\page-props-factory\extract-path.ts</code> file of a Next.js application with the Personalize add-on installed.</p><p id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_para-idm1403329786088492">For additional information, see the <a class="link" href="https://github.com/Sitecore/jss/blob/release/21.0.0/ref-docs/sitecore-jss-nextjs/modules/index.md#normalizepersonalizedrewrite" target="_blank" rel="noopener">reference documentation</a>.</p><h3 id="idm45599227692960" class="bridgehead">getPersonalizedRewriteData</h3><p>The <code class="code">getPersonalizedRewriteData</code> function extracts personalization data (<code class="code">variantId</code>) from a personalized rewrite path. The Page Props Factory plugin for personalization, defined in the <code class="code">src/lib/papge-props-factory/plugins/personalize.ts</code> file, passes the data to the <code class="code">personalizeLayout</code> function.</p><p id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_para-idm1403329786114074">For additional information, see the <a class="link" href="https://github.com/Sitecore/jss/blob/release/21.0.0/ref-docs/sitecore-jss-nextjs/modules/index.md#getpersonalizedrewritedata" target="_blank" rel="noopener">reference documentation</a>.</p><h3 id="idm45599227689088" class="bridgehead">personalizeLayout</h3><p>The <code class="code">personalizeLayout</code> function modifies layout data to use a specific variant based on the provided <code class="code">variantId</code> parameter instead of the default layout. The function also sets the <code class="code">variantId</code> property on the Sitecore context.</p><p id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_para-idm1403329786145576">For additional information, see the <a class="link" href="https://github.com/Sitecore/jss/blob/release/21.0.0/ref-docs/sitecore-jss-nextjs/modules/index.md#personalizelayout" target="_blank" rel="noopener">reference documentation</a>.</p><h3 id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_bridgehead-idm1403329765480076" class="bridgehead">CdpHelper</h3><p>The <code class="code">CdpHelper</code> class provides the <code class="code">getPageVariantId</code> function that gets the page variant identifier in the format required for the <code class="code">pageVariantId</code> parameter of a Page View event.</p><p id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_para-idm1403329786165890">For additional information, see the <a class="link" href="https://github.com/Sitecore/jss/blob/release/21.0.0/ref-docs/sitecore-jss-nextjs/classes/index.CdpHelper.md#getpagevariantid" target="_blank" rel="noopener">reference documentation</a>.</p></div></div></section><section dir="ltr" class="section accordion" data-origin-id="" data-publication-date="06/30/23" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4634652232780833297680134555"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4634652232780833297680134555_body" data-parent="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4634652232780833297680134555"><div><div class="title"><h2 class="title" style="clear: both">Environment variables</h2></div></div></a></div></div><div class="panel-body collapse" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4634652232780833297680134555_body"><p>You use environment variables to configure the Personalize add-on.</p><p>The following table lists the environment variables specific to the Next.js personalize add-on. You must populate all the required variables with values specific to your project/environment.</p><div class="informaltable table-responsive"><table style="width:100%;" class="informaltable frame-void rules-rows"><thead><tr><th class="th"><p>Variable</p></th><th class="th"><p>Description</p></th><th class="th"><p>Values</p></th></tr></thead><tbody><tr><td class="td"><p><code class="code">NEXT_PUBLIC_CDP_TARGET_URL</code></p></td><td class="td"><p>Required.</p><p>A CDP target URL.</p><p>Used in personalization middleware and page view events.</p></td><td class="td"><p>Default: (none)</p><p>Example values:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>https://api-engage-eu.sitecorecloud.io</p></li><li class="listitem"><p>https://api-engage-us.sitecorecloud.io</p></li><li class="listitem"><p>https://api-engage-ap.sitecorecloud.io</p></li></ul></div></td></tr><tr><td class="td"><p><code class="code">NEXT_PUBLIC_CDP_CLIENT_KEY</code></p></td><td class="td"><p>Required.</p><p>The CDP client key.</p><p>Used in personalization middleware and page view events.</p></td><td class="td"><p>Default: (none)</p><p>Example value: pqsPERS3lw12v5a9rrHPW1c4hET73GxQ</p></td></tr><tr><td class="td"><p><code class="code">NEXT_PUBLIC_CDP_POINTOFSALE</code></p></td><td class="td"><p>Required.</p><p>A string or a map of locales and strings.</p><p>Used in personalization middleware and page view events.</p><p>When using the Next.js Multisite add-on, the value of the variable represents the Point of Sale (POS) configuration of the default/configured site. When <a class="link linktype-component" href="the-next-js-multisite-add-on.html#UUID-be76d43e-8a3a-019c-3715-81682495783a_bridgehead-idm1403359805757226" title="SiteResolver">configuring multiple sites (for specific hostnames)</a>, the application uses the automatically-fetched site information containing the POS configuration.</p></td><td class="td"><p>Default: (none)</p><p>Single value example: <code class="code">example.com</code>.</p><p>Locales map example:</p><pre class="programlisting json" data-language="json" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_programlisting-idm4544439248907233297669645072">{"en": "example.com", "da": "example.com/da"}</pre></td></tr><tr><td class="td"><p><code class="code">NEXT_PUBLIC_PERSONALIZE_SCOPE</code></p></td><td class="td"><p>Optional.</p><p>In XM Cloud Personalize, unique page identifiers are used to run personalization flows and analytics. In some cases, identical page identifiers exist across different XM Cloud environments, for example, if pages are created through site serialization.</p><p>Use this variable to Isolate personalization data between such XM Cloud environments. It creates a unique page personalization identifier for each environment.</p></td><td class="td"><p>Default: (none)</p><p>If you don't use the variable, the default structure for identifying a personalized page is:</p><pre class="programlisting" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_programlisting-idm4531257222614433757622779364">embedded_{pageID}_{language}</pre><p>After adding the <code class="code">PAGES_PERSONALIZE_SCOPE</code> variable with a value of <code class="code">myEnv</code>, for example, that ID is changed to:</p><pre class="programlisting" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_programlisting-idm4589737174128033757625280882">embedded_myEnv_{pageID}_{language}</pre></td></tr><tr><td class="td"><p><code class="code">PERSONALIZE_MIDDLEWARE_CDP_TIMEOUT</code></p></td><td class="td"><p>Optional.</p><p>Value is in milliseconds. Provides the ability to fine-tune timeout for CDP calls within the personalization middleware. If the timeout is exceeded, the user sees the default page.</p></td><td class="td"><p>Default: 400</p></td></tr><tr><td class="td"><p><code class="code">PERSONALIZE_MIDDLEWARE_EDGE_TIMEOUT</code></p></td><td class="td"><p>Optional.</p><p>Value is in milliseconds. Provides the ability to fine-tune timeout for Experience Edge calls within the personalization middleware. If the timeout is exceeded, the user sees the default page.</p></td><td class="td"><p>Default: 400</p></td></tr></tbody></table></div><div dir="ltr" class="note"><h3 class="title">Note</h3><p>You can find the <code class="code">NEXT_PUBLIC_CDP_POINTOFSALE</code>, <code class="code">NEXT_PUBLIC_CDP_TARGET_URL</code>, and <code class="code">NEXT_PUBLIC_CDP_CLIENT_KEY</code> values in your XM Cloud Site <span class="guilabel">Settings</span> under the <span class="guilabel">Developer Settings</span> tab.</p><p>You must add points of sale to Site identifiers to use them in analytics.</p></div></div></div></section><section dir="ltr" class="section accordion" data-origin-id="" data-publication-date="06/30/23" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4610524765630433297655278555"><div class="accordion-icon"></div><div class="panel panel-default"><div class="panel-heading"><div class="titlepage"><a data-toggle="collapse" href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4610524765630433297655278555_body" data-parent="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4610524765630433297655278555"><div><div class="title"><h2 class="title" style="clear: both">Limitations</h2></div></div></a></div></div><div class="panel-body collapse" id="UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4610524765630433297655278555_body"><p>The Personalize add-on has the following limitations:</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem"><p>The Next.js Personalize add-on is only compatible with XM Cloud.</p></li><li class="listitem"><p>Automatic provisioning of CDP tenants and Point of Sale management is only possible if you create a new project in XM Cloud using a Starter Kit.</p></li></ul></div></div></div></section></section><div class="footer-content"><div class="glossary-definitions"></div></div><footer></footer></div></article><aside class="section-nav-container"><ul class="section-nav nav"><li><a href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e">The Next.js Personalize add-on</a></li><li><a href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372">Architecture overview</a></li><li><a href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4568099155700833297646658689">Understanding the personalized rewrite path</a></li><li><a href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041657171233297649869879">APIs</a></li><li><a href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4634652232780833297680134555">Environment variables</a></li><li><a href="#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4610524765630433297655278555">Limitations</a></li></ul></aside></main><div id="bottom-pager"><ul class="pager"><li class="previous"><a accesskey="p" class="prev pull-left prev visible-lg visible-md" id="header-navigation-prev" href="add-ons-for-next-js-applications.html">Prev</a></li><li class="next"><a accesskey="n" class="pull-right next visible-lg visible-md" id="header-navigation-next" href="the-next-js-personalize-add-on.html#UUID-c7590e6c-5fd6-6e80-eeae-f5d65fd4aa8e_section-idm4587041762993633297643609372">Next</a></li></ul></div><footer class="site-footer"><div class="inner"><div class="copyright"> © 2023 Sitecore </div><div class="date-modified"><span class="date-modified-text">Last modified: </span><span class="formatted-date">06/29/2023</span></div><div class="publication-date"><span class="publication-date-text">Publication date</span><span class="pubdate-delimiter">: </span><span class="formatted-date">06/30/23</span></div></div></footer></div></div></div></div><script type="text/javascript" src="//customer.cludo.com/scripts/bundles/search-script.min.js"></script><script>
			var CludoSearch;
			(function () {
			var cludoSettings = {
			customerId: 2063,
			engineId: 12826,
			language: 'en',
			searchInputs: ["search-form","cludo-search-content-form","cludo-search-mobile-form"],
			hideSearchFilters: true,
			type: 'standardOverlay',
			facets: ["Category", "ProductVer", "Product", "Version"],
			useStandardSearchTemplate: false,
			customerTemplate: "OverlayCopy",
			searchApiUrl: 'https://api-eu1.cludo.com/api/v3'
			};
			CludoSearch= new Cludo(cludoSettings);
			CludoSearch.init();
			})();
		</script><!-- www.Cludo.com Search body init script start --></body></html>
